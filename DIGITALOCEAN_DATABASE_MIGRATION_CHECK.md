# QCard DigitalOcean Database Migration Verification Guide

This guide helps you verify that database migrations are correctly applied in your DigitalOcean environment, specifically addressing issues with project access.

## How to Check Migration Status

```bash
# Set your DigitalOcean database connection
export DATABASE_URL=postgresql://doadmin:your-password@your-db-host.db.ondigitalocean.com:25060/defaultdb?sslmode=require

# Check migration status
npx prisma migrate status

# List all tables in the database
npx prisma db execute --file=./scripts/list-tables.sql

# Verify the Project table exists and has the correct structure
npx prisma db execute --sql="SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'project' ORDER BY ordinal_position;"
```

## Common Migration Issues and Solutions

### Issue 1: Project Table Missing

If the Project table is missing entirely:

```bash
# Force push the schema to create the missing tables
npx prisma db push --skip-generate
```

### Issue 2: Wrong Migration Provider

If the error indicates an issue with the migration provider:

```bash
# Update the migration lock file
echo '# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"' > prisma/migrations/migration_lock.toml

# Push changes
git add prisma/migrations/migration_lock.toml
git commit -m "Fix: Update migration provider to PostgreSQL"
git push
```

### Issue 3: Missing Columns in Project Table

If the Project table exists but is missing columns:

```bash
# Check the current columns
npx prisma db execute --sql="SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'project' ORDER BY ordinal_position;"

# Force a schema push to add missing columns
npx prisma db push --force-reset
```

⚠️ WARNING: `--force-reset` will destroy your existing data! Only use this on test/development environments or if you've backed up your data.

## Verifying Fix

After applying migrations, check that the following tables exist with the correct structure:

1. Project
2. ProjectMember
3. Studio (with proper relation to Tenant)

```bash
# Run verification script
node scripts/do-deployment-fix.js
```

## Deployment Process Best Practices

To avoid migration issues in the future:

1. **Always use the same database provider** (PostgreSQL) in both development and production
2. **Include migrations in your build script**:

```json
// In package.json
"do:deploy": "npx prisma migrate deploy && npx prisma generate && next build"
```

3. **Set the correct build command** in DigitalOcean App Platform settings:

```
npm run do:deploy
```

4. **Initialize required records** for all users:

```bash
npm run db:startup-fix
```

## Troubleshooting

If you continue to experience issues:

1. Check the Prisma ORM logs in your application
2. Verify that the database user has appropriate permissions to create/alter tables
3. Ensure SSL settings are correct for DigitalOcean managed databases
4. Check the database schema matches the Prisma schema

## Support

If you continue to experience issues, please contact the development team with:
- Screenshot of the error
- Output from `npx prisma migrate status`
- Database connection information (without sensitive credentials)