# QCard DigitalOcean Project Access Fix

This guide provides specific instructions to fix issues with project access in your DigitalOcean deployment.

## Problem Description

Users with STUDIO tenant type cannot access or create projects, resulting in 404 errors when:
- Trying to view the projects page (`/studio/projects`)
- Attempting to create a new project (`/studio/projects/new`)
- Accessing an existing project (`/studio/projects/[id]`)

## Root Cause Analysis

This issue is typically caused by one or more of the following:

1. **Missing Studio Initialization**: Users have the STUDIO tenant type but no actual Studio record, causing "Studio not found" errors
2. **Table Creation Issues**: The Project table was not created properly during migration
3. **Migration Provider Mismatch**: The migration lock file specifies a provider different from what's used in deployment
4. **Build Command Problems**: The deployment build command does not include proper migration steps

## Fix Instructions

### Quick Fix

Run the deployment fix script that will automatically diagnose and repair common issues:

```bash
# Set your database connection info
export DATABASE_URL=postgresql://doadmin:your-password@your-db-host.db.ondigitalocean.com:25060/defaultdb?sslmode=require

# Run the fix script
node scripts/do-deployment-fix.js

# Redeploy your application
npm run do:deploy
```

### Manual Fix Steps

If the quick fix doesn't work, follow these steps:

#### 1. Verify Database Connection

```bash
export DATABASE_URL=postgresql://doadmin:your-password@your-db-host.db.ondigitalocean.com:25060/defaultdb?sslmode=require

# Test connection
node -e "const { Client } = require('pg'); const client = new Client({ connectionString: process.env.DATABASE_URL, ssl: { rejectUnauthorized: false } }); client.connect().then(() => { console.log('Connected successfully'); client.end(); }).catch(e => console.error('Connection failed:', e))"
```

#### 2. Check Essential Tables

```bash
# List tables
npx prisma db execute --file=./scripts/list-tables.sql

# Check if project tables exist
npx prisma db execute --sql="SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name LIKE '%project%'"
```

#### 3. Fix Missing Studio Records

```bash
# Run the studio initialization fix
node scripts/startup-fix.js
```

#### 4. Push Schema Changes if Needed

```bash
# Push schema to ensure all tables exist
npx prisma db push --skip-generate

# Regenerate Prisma client
npx prisma generate
```

#### 5. Update Build Command in DigitalOcean

Ensure your DigitalOcean App Platform settings use the correct build command:

```
npm run do:deploy
```

#### 6. Fix migration lock file

Ensure your `prisma/migrations/migration_lock.toml` file has:

```toml
# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"
```

## Verification

After applying the fixes:

1. Visit `/api/health` to verify all tables exist
2. Try accessing `/studio/projects`
3. Create a new project
4. View an existing project

## Common Pitfalls

- **Schema Mismatch**: Local development uses SQLite but production uses PostgreSQL
- **Missing Studios**: Users have STUDIO tenant type but no studio record
- **Incorrect Build Command**: Build command doesn't run migrations
- **SSL Requirement**: PostgreSQL connection doesn't include `?sslmode=require`
- **Missing Project Pages**: Ensure all project pages are properly deployed

## Support

If you continue to experience issues, please contact the development team with:
- Screenshot of the error
- URL you're trying to access
- Output from `/api/health` endpoint
- DigitalOcean App logs